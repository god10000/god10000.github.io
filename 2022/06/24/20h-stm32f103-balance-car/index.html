<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="南北的猫" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  
  
  <title>
    
      stm32f103平衡小车 
      
      
      |
    
     南北的猫
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.1.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Northcat</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">stm32f103平衡小车</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2024-06-03 10:26:41
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/STM32F103/" title="STM32F103">
                    #STM32F103
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h2 id="材料清单"><a href="#材料清单" class="headerlink" title="材料清单"></a>材料清单</h2><blockquote>
<p>1.stm32f103c8t6最小系统板<br>2.TB6612电机驱动(可用L298N或者DRV8848替代)<br>3.MPU6050<br>4.两轮小车底盘(电机需要带编码器)<br>5.0.96oled屏幕<br>6.降压模块</p>
</blockquote>
<ul>
<li>资源分配图</li>
</ul>
<img src="/2022/06/24/20h-stm32f103-balance-car/image-20240406142348401.png" class="" title="image-20240406142348401">

<h2 id="编写程序"><a href="#编写程序" class="headerlink" title="编写程序"></a>编写程序</h2><p>编写程序之前,先画一个思维导图,理清各个程序之间的关系,以及小车正常工作的流程图<br>基础的程序包含以下几个部分</p>
<blockquote>
<p>1.motor<br>2.pwm<br>3.encoder<br>4.mpu6050<br>5.exti<br>6.oled<br>7.control<br>后续还可以进行二次开发,加上led,key,bluetooth(usart),避障等功能</p>
</blockquote>
<h3 id="motor"><a href="#motor" class="headerlink" title="motor"></a>motor</h3><p>1.让电机转起来<br>motor,引脚设置成输出,两个电机需要四个引脚对应AIN1,AIN2,BIN1,BIN2<br>ENA  IN1  IN2<br>0       任意  任意   停止<br>1       0         0       停止<br>1       0         1        正转</p>
<blockquote>
<p>具体接线描述：L298N的out1和out2接电机的正负极，IN1和IN2分别对应开发板的PA4和PA5，12V电源接入L298N的12V供电和GND，然后将开发板的gnd和l298n的gnd连接（一定要共地）接线完工<br>PWM设置值,就是电机的速度</p>
</blockquote>
<h3 id="PWM"><a href="#PWM" class="headerlink" title="PWM"></a>PWM</h3><p><img src="https://img-blog.csdnimg.cn/b94068adf5894da797e5b296b3985d38.png" alt="img"></p>
<p>好像改变ARR(自动重装载值)会改变占空比(CCR&#x2F;ARR), 周期也会变, 改变psc应该改变的是斜率, 越大斜率越小, 所以改变占空比, 也就是高电平所占的时间,会改变电机速度,改变频率,会改变电机响应速度,频率过低会有噪音和震动</p>
<p>ARR : 决定PWM周期(在时钟频率一定的情况下,当前为默认内部时钟CK_INT)</p>
<p>CCRx : 决定PWM占空比(高低电平所占整个周期比例)</p>
<ol>
<li><p><code>TIM1_PWM_Init(899, 0)</code>: 这种设置下，ARR被设置为899，PSC被设置为0。这意味着PWM的周期为ARR+1个计数值，也就是900个计数值，而预分频因子为1。这种设置适用于需要较快的PWM输出频率的情况。</p>
</li>
<li><p><code>PWM_Init_TIM1(0, 7199)</code>: 这种设置下，ARR被设置为0（实际上是最大值65535），PSC被设置为7199。这意味着PWM的周期为1个计数值，预分频因子为7200。这种设置适用于需要较慢的PWM输出频率的情况。</p>
<h3 id="代码构建"><a href="#代码构建" class="headerlink" title="代码构建"></a>代码构建</h3><blockquote>
<ul>
<li><p>初始化GPIO结构体</p>
</li>
<li><p>初始化时基结构体</p>
</li>
<li><p>配置输出比较参数</p>
</li>
<li><p>使能定时器</p>
</li>
</ul>
</blockquote>
</li>
</ol>
<blockquote>
<p>也就是，在一定的频率下，通过不同的占空比 即可得到不同的输出模拟电压<br>pwm就是通过这种原理实现D&#x2F;A转换的。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/3380f0796eab461eb64bf86559486cb8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAfuWxseacieacqOWFrg==,size_20,color_FFFFFF,t_70,g_se,x_16#pic_center" alt="在这里插入图片描述"></p>
<h3 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h3><p><strong>为什么编码器读数要强制转换成short</strong></p>
<p>TIM_GetCounter 函数本身读回的是 uint16_t 数据类型,short强制类型转换。本来我们从定时器读取到的计数值范围是0到65535，但转换成short后范围就变成了-32768到32767，这是为了使得轮子的正转和反转(编码器向上和向下计数)能够对应正的计数值和负的计数值</p>
<p><strong>那么short与int的区别是什么, int不也可以吗</strong></p>
<p>可以, 区别在keil中所占字节不同</p>
<blockquote>
<p>int 占用 4 字节</p>
<p>short int 占用 2 字节</p>
</blockquote>
<p>[-BanlanceCar&#x2F;平衡小车V2&#x2F;keil STM32数据类型问题.png at master · Frank-zheng-C&#x2F;-BanlanceCar · GitHub](<a target="_blank" rel="noopener" href="https://github.com/Frank-zheng-C/-BanlanceCar/blob/master/%E5%B9%B3%E8%A1%A1%E5%B0%8F%E8%BD%A6V2/keil">https://github.com/Frank-zheng-C/-BanlanceCar/blob/master/平衡小车V2/keil</a> STM32数据类型问题.png)</p>
<p><strong>Encoder.c是否需要中断函数</strong></p>
<p>个人觉得可加可不加, 因为这里中断函数只是在溢出的时候清除中断标志位, 防止计数停止</p>
<p>由于函数里编码器读取计数值后会对清零计数值, 所以一般不会溢出</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>全称类型说明符</th>
<th>缩写类型说明符</th>
<th>位数</th>
<th>范围</th>
</tr>
</thead>
<tbody><tr>
<td>整型</td>
<td>int</td>
<td>int</td>
<td>16位</td>
<td>-32768至+32767</td>
</tr>
<tr>
<td>无符号整型</td>
<td>unsigned int</td>
<td>unsigned</td>
<td>16位</td>
<td>0 至 65,535</td>
</tr>
<tr>
<td>短整型</td>
<td>short int</td>
<td>short</td>
<td>16位</td>
<td>-32768至+32767</td>
</tr>
<tr>
<td>无符号短整型</td>
<td>unsigned short int</td>
<td>unsigned short</td>
<td>16位</td>
<td>0 至 65,535</td>
</tr>
<tr>
<td>长整型</td>
<td>long int</td>
<td>long</td>
<td>32位</td>
<td>-2,147,483,648 至 2,147,483,647</td>
</tr>
<tr>
<td>无符号长整型</td>
<td>unsigned long int</td>
<td>unsigned long</td>
<td>32位</td>
<td>0至4,294,967,295</td>
</tr>
</tbody></table>
<p>编码器线数：线数就是编码器的分辨率，即转一圈发出的脉冲数</p>
<p>脉冲值正比于实际速度,但不是实际速度,需要进一步计算</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;&#x2F;速度测量值   
velocity &#x3D; ( read_encoder2() + read_encoder3() )&#x2F;2;
&#x2F;&#x2F;获取最新速度偏差&#x3D;&#x3D;测量速度（左右编码器之和）-目标速度（此处为零） 
Encoder_Least &#x3D;0-(encoder_left+encoder_right); <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>个人理解:这个偏差最后要*kp,相当于直接算到kp里面了,<code>PWM_out=Velocity_Kp*EnC_Err_Lowout+Velocity_Ki*Encoder_S;</code></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhao_ke_xue/article/details/108305821?ops_request_misc=%7B%22request_id%22:%22169148867816800213097839%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=169148867816800213097839&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-3-108305821-null-null.142%5Ev92%5Einsert_down28v1&utm_term=%E5%B9%B3%E8%A1%A1%E5%B0%8F%E8%BD%A6%E7%9A%84%E5%AE%9E%E9%99%85%E9%80%9F%E5%BA%A6&spm=1018.2226.3001.4187">平衡小车从原理到实践_平衡小车控制原理_白茶-清欢的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_56760882/article/details/123935485?ops_request_misc=&request_id=&biz_id=102&utm_term=%E9%9C%8D%E5%B0%94%E7%BC%96%E7%A0%81%E7%94%B5%E6%9C%BA%E7%9A%84%E7%BA%BF%E6%95%B0%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-123935485.142%5Ev89%5Einsert_down28v1,239%5Ev2%5Einsert_chatgpt&spm=1018.2226.3001.4187">【一文读懂】如何用编码器测速_荒野火狐的博客-CSDN博客</a></p>
<h3 id="MPU6050"><a href="#MPU6050" class="headerlink" title="MPU6050"></a>MPU6050</h3><p>参考<a href="">     </a></p>
<p>有一个问题:<br>mpu6050供电时候的位姿不同确定的机械中值也不同</p>
<img src="/2022/06/24/20h-stm32f103-balance-car/01.jpg" class="" title="大佬的方法">

<h1 id="重学平衡小车"><a href="#重学平衡小车" class="headerlink" title="重学平衡小车"></a>重学平衡小车</h1><h2 id="PID控制"><a href="#PID控制" class="headerlink" title="PID控制"></a>PID控制</h2><p>比例项：提高响应速度，减小静差。</p>
<p>积分项：消除稳态误差。只要有偏差，我就积分，有一丁点偏差，我也会积分。积积，就会非常大。直到你偏差变为0.</p>
<p>微分项：减小震荡以及超调。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Pwm&#x3D;Kp*e(k)+Ki*∑e(k)+Kd*[e(k)-e(k-1)]

Kp*e(k)
Ki*∑e(k)
Kd*[e(k)-e(k-1)]

Ki&#x3D;Kp*(1&#x2F;Ti) *Ti
Kd&#x3D;Kp*(1&#x2F;T)*Td

可见Ki、Kd都有Kp、所以Kp的值也会影响Ki、Kd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="位置PID"><a href="#位置PID" class="headerlink" title="位置PID"></a>位置PID</h3><p><strong>1.理论分析</strong></p>
<p>位置闭环控制就是根据编码器的脉冲累加测量电机的位置信息，并与目标值进行比较，得到控制偏差，</p>
<p>然后通过对偏差的比例、积分、微分进行控制，使偏差趋向于零的过程。</p>
<p><strong>2.公式</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Pwm&#x3D;Kp\*e(k)+Ki\*∑e(k)+Kd\*[e(k)-e(k-1)]

e(k)：本次偏差

e(k-1)：上一次的偏差  

∑e(k)：e(k)以及之前的偏差的累积和;其中k为1,2,,k;

Pwm代表输出<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3.结构框图</p>
<style>.mjsmrqmlhagp{zoom:150%;}</style><img src="/2022/06/24/20h-stm32f103-balance-car/wps1.jpg" class="mjsmrqmlhagp" alt="img">

<ol start="4">
<li>C语言实现</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">int Position_PID (int Encoder , int Target)

 &#123; 	

  static float Bias, Pwm, Integral_bias, Last_Bias;

  Bias&#x3D;Encoder-Target; &#x2F;&#x2F;计算偏差

  Integral_bias+&#x3D;Bias; &#x2F;&#x2F;求出偏差的积分	   

  Pwm&#x3D;Position_KP*Bias+Position_KI*Integral_bias+Position_KD*(Bias-Last_Bias);  &#x2F;&#x2F;位置式PID控制器   

  Last_Bias&#x3D;Bias;    &#x2F;&#x2F;保存上一次偏差 

  return Pwm;      &#x2F;&#x2F;输出

 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="2-公式为什么kp不-误差"><a href="#2-公式为什么kp不-误差" class="headerlink" title="2.公式为什么kp不*误差"></a>2.公式为什么kp不*误差</h1><h3 id="串级PID"><a href="#串级PID" class="headerlink" title="串级PID"></a>串级PID</h3><p><strong>直立环</strong></p>
<ol>
<li><p>平衡理论</p>
<p>小车往那边倒，车轮就往哪边开，既可以保持车子的平衡。</p>
<img src="/2022/06/24/20h-stm32f103-balance-car/wps2.jpg" class="" title="img">
</li>
<li><p>公式</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">a&#x3D;b1*θ+b2*θ;		——&gt;		比例微分控制【PDout&#x3D;Kp*Angle+Kd*( Angle-Angle_last)】<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>结构框图</p>
</li>
</ol>
<style>.gwucgcbyrrub{zoom:150%;}</style><img src="/2022/06/24/20h-stm32f103-balance-car/wps3.jpg" class="gwucgcbyrrub" alt="img"> 

<p><strong>直立环：让小车角度趋近0；</strong></p>
<p><strong>速度环：让电机速度趋近0；</strong></p>
<h3 id="速度环、串级PID"><a href="#速度环、串级PID" class="headerlink" title="速度环、串级PID"></a>速度环、串级PID</h3><style>.peitkezxypol{zoom: 150%;}</style><img src="/2022/06/24/20h-stm32f103-balance-car/wps4.jpg" class="peitkezxypol" alt="img"> 

<p>速度环输入：1.给定速度。2.速度反馈。</p>
<p>输出：<strong>角度值</strong>（直立环的期望速度输入）</p>
<p>直立环输入：1.给定角度（速度环输出）。2.角度反馈</p>
<p>输出：PWM（直接控制小车）</p>
 <pre class="line-numbers language-C" data-language="C"><code class="language-C">Vertical_out&#x3D;Kp1*( real_Angle- expect_Angle)+Kd*D( real_Angle- expect_Angle)				 &#x2F;&#x2F;直立PD控制器

Velocity_out &#x3D;Kp2*(Encoder_ real- Encoder_ expect)+Ki*S(Encoder_ real- Encoder_ expect)		 &#x2F;&#x2F;速度PI控制器
（NOTE：（1）Velocity_out &#x3D; expect_Angle.（2）Kp1：Vertical_Kp.（3）Kp2：Velocity_Kp.）

&#x2F;&#x2F;解释
直立环输出&#x3D;Kp1*（真实角度-期望角度+机械中值）+Kd*角度偏差的微分					  &#x2F;&#x2F;角度偏差&#x3D;真实角度-期望角度
速度环输出&#x3D;Kp2*（反馈编码器值-期望编码器值）+Ki*编码器偏差的积分					
&#x2F;&#x2F;编码器偏差&#x3D;反馈编码器值-期望编码器值（NOTE：（1）速度环输出&#x3D;直立环的期望角度。（2）Kp1：直立环Kp。（3）Kp2：速度环Kp。）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol>
<li><strong>为什么输出是角度值呢</strong></li>
</ol>
<p>​		是因为就是这样定义的吗,这样的Kp就相当于<strong>计数值与角度值的线性关系</strong></p>
<blockquote>
<p>在这个控制系统中，速度环的输出实际上是一个<strong>中间变量</strong>，它将速度控制转换为角度控制的设定值。这样做的原因在于平衡小车的物理和动力学特性。小车为了向前或向后移动，必须倾斜到一定角度，利用重力分力来产生前进或后退的驱动力。因此，通过调整小车的倾斜角度，我们可以间接控制它的速度。</p>
</blockquote>
<p>也就是说, 这样的Kp就相当于<strong>计数值与角度值的线性关系</strong>, 是人为定义通过调节kp达到的输出的角度值, 也可以输出别的, 改变kp就变成了其他的输出量</p>
<blockquote>
<p>对，你的理解是正确的。在平衡小车的PID控制中，Kp（比例系数）的设定基本上定义了输入（如速度误差或角度误差）与输出（如倾斜角度或PWM信号）之间的线性关系。通过调节Kp的大小，可以改变这种线性关系的敏感度和响应速度，从而影响小车的控制效果。</p>
<p>总结来说，Kp的设定是人为定义的，通过调节它可以改变控制系统的行为。不仅限于输出角度或PWM，理论上可以调整PID控制器来输出任何通过数学关系能够从输入误差计算得到的量。这种灵活性使得PID控制器非常适用于各种需要精确控制的自动化系统。</p>
</blockquote>
<p>我的理解是这个角度输出<strong>我定义的</strong>,我也可以打那将其定义为角速度,加速度,力矩,都可以对吗,因为我可以通过调节kp调节他们之间的线性关系,比如我需要输入5时,输出10的,力矩,那么kp,就为2,输出就为力矩</p>
<blockquote>
<p>对, 输出的物理量（如角度、角速度、加速度、力矩等）是由设计者根据具体应用需求来定义的。通过调节PID控制器的参数（Kp、Ki、Kd），你可以设定输入和输出之间的具体数学关系，从而控制系统的行为。</p>
</blockquote>
<p>直立环输入：1.给定角度（速度环输出）。2.角度反馈</p>
<p>输出：PWM（直接控制小车）</p>
 <pre class="line-numbers language-C" data-language="C"><code class="language-C">Vertical_out&#x3D;Kp1*( real_Angle- expect_Angle)+Kd*D( real_Angle- expect_Angle)				 &#x2F;&#x2F;直立PD控制器

Velocity_out &#x3D;Kp2*(Encoder_ real- Encoder_ expect)+Ki*S(Encoder_ real- Encoder_ expect)		 &#x2F;&#x2F;速度PI控制器

（NOTE：（1）Velocity_out &#x3D; expect_Angle.（2）Kp1：Vertical_Kp.（3）Kp2：Velocity_Kp.）

【中文】

直立环输出&#x3D;Kp1*（真实角度-期望角度+机械中值）+Kd*角度偏差的微分					  &#x2F;&#x2F;角度偏差&#x3D;真实角度-期望角度

速度环输出&#x3D;Kp2*（反馈编码器值-期望编码器值）+Ki*编码器偏差的积分					&#x2F;&#x2F;编码器偏差&#x3D;反馈编码器值-期望编码器值

（NOTE：（1）速度环输出&#x3D;直立环的期望角度。（2）Kp1：直立环Kp。（3）Kp2：速度环Kp。）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li><strong>速度环是正反馈还是负反馈</strong></li>
</ol>
<blockquote>
<p>正反馈</p>
<p>因为当车身向右倾斜时,会产生误差,如果此时是负反馈,导致车轮反转和停止都会加速小车倒下</p>
<p>所以车身右倾车轮需要往右转,倾斜角度越大,转速越快</p>
</blockquote>
<ol start="3">
<li><p>速度环起什么作用</p>
</li>
<li><p>只用直立环是否可行</p>
</li>
</ol>
<blockquote>
<p><strong>只有直立环的情况</strong></p>
<ul>
<li><strong>直立环</strong>：保持垂直。直立环通过比较当前角度与目标角度（通常是0度，即完全垂直）的差异来计算控制信号，调整电机以维持平衡。如果小车被推动，它会自动调整角度回到平衡点，但不会主动返回到原始位置。</li>
<li>也就是说,向右推,小车会向右走,直到角度变为期望角度(0),但是<code>如果幅度较大,加速来不及,小车会直接诶倒下</code></li>
</ul>
<p><strong>加入速度环</strong></p>
<ul>
<li><strong>速度环</strong>：当加入速度环后，系统不仅能维持平衡，还能控制小车的位置或速度。速度环通过监测小车的实际位置或速度与期望位置或速度的偏差来生成控制信号。</li>
</ul>
</blockquote>
<blockquote>
<p>关于直立环反应慢的原因，以及速度环如何提升系统响应速度的具体机制，这些问题都涉及到PID控制理论和平衡小车的动态性质。我们一步步来探讨这些问题，包括串级PID和并级PID在控制策略上的不同及其对系统性能的影响。</p>
<h3 id="为什么直立环反应较慢？"><a href="#为什么直立环反应较慢？" class="headerlink" title="为什么直立环反应较慢？"></a>为什么直立环反应较慢？</h3><ol>
<li><strong>物理和系统动力学限制</strong>：</li>
</ol>
<ul>
<li>直立环的目的是维持小车垂直平衡，这通常依赖于倾角传感器（如陀螺仪）的反馈。倾角的测量和响应虽然在时间上很短，但存在物理延迟，特别是在倾角变化速度很快时，系统需要时间来产生足够的反馈力。</li>
<li>直立环的PID参数设置必须谨慎，特别是微分项（Kd），它对小车的动态响应非常敏感，过高可能会导致振荡，过低则可能响应不足。</li>
</ul>
<ol start="2">
<li><strong>计算延迟</strong>：</li>
</ol>
<ul>
<li>PID控制算法虽然执行速度快，但仍受限于处理周期和控制算法的复杂性。尤其是在需要高精度或高反应速度的场合，控制器的计算能力可能成为瓶颈。</li>
</ul>
<h3 id="速度环如何加快响应？"><a href="#速度环如何加快响应？" class="headerlink" title="速度环如何加快响应？"></a>速度环如何加快响应？</h3><ol>
<li>预测和前馈控制</li>
</ol>
<ul>
<li>速度环可以视作一种前馈控制机制，当直立环计算出需要改变倾斜角度以保持平衡时，速度环通过调整小车的移动速度来辅助这一变化。这样可以提前调整，而不是完全依赖于倾角的被动响应。</li>
<li>速度环通过增加或减少小车的整体速度，加速达到直立环计算的目标倾斜角度，从而加快系统对失衡状态的响应。</li>
</ul>
<h3 id="串级PID与并级PID的区别"><a href="#串级PID与并级PID的区别" class="headerlink" title="串级PID与并级PID的区别"></a>串级PID与并级PID的区别</h3><p>尽管在最终输出上，串级和并级PID可能看起来类似（都是调整PWM信号），但控制逻辑和系统的内部动态有本质的不同：</p>
<ol>
<li><strong>串级PID</strong>：</li>
</ol>
<ul>
<li>在串级PID中，外环（速度环或位置环）的输出是内环（直立环）的输入。这意味着外环设定了一个目标倾斜角度，直立环根据这个目标倾斜角度调整PWM输出以尝试达到这个倾角。</li>
<li>这种层级结构使得每个环可以专注于一个具体的控制目标，如速度环控制行驶速度，直立环确保倾角调整，提升了控制精度和系统稳定性。</li>
</ul>
<ol start="2">
<li><strong>并级PID</strong>：</li>
</ol>
<ul>
<li>在并级PID中，直立环和速度环各自独立计算各自的控制信号（PWM），然后将这些信号合并应用到驱动系统。每个环对最终的驱动信号直接贡献，无须通过另一个环的中介。</li>
<li>这种结构简化了控制系统的设计，但可能降低了控制的准确性和反应的协调性，因为各环的输出可能在没有足够协调的情况下直接叠加。</li>
</ul>
</blockquote>
<h1 id="没关系-岁月还长-有些问题可以慢慢想"><a href="#没关系-岁月还长-有些问题可以慢慢想" class="headerlink" title="没关系,岁月还长,有些问题可以慢慢想"></a>没关系,岁月还长,有些问题可以慢慢想</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1H7411k76N?vd_source=f525a47bd6d8cb5b154158289da1d4d4">平衡小车的代码框架——代码开源-第3.1节</a></p>
<h3 id="并级PID"><a href="#并级PID" class="headerlink" title="并级PID"></a>并级PID</h3><p>其实这个并级PID ,相当于二元函数,两个KP对应线性关系,输出PWM,请问对吗</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">是的，你的理解是正确的。在这个并级PID控制系统中，可以将其视为一个处理两个输入变量的二元函数，其中每个变量分别通过自己的PID控制器处理。这里的两个变量是小车的角度（直立环）和速度（速度环），每个环都有自己的比例系数（Kp），积分系数（Ki）以及微分系数（Kd）（虽然在速度环的代码示例中没有展示微分控制）。

&#x2F;&#x2F;解析并级PID
在并级PID中，每个控制环独立地计算其PID输出，然后将这些输出合并以形成最终的控制信号（如PWM）。在你提到的例子中，这种合并是简单的算术加法，即：

每个控制环通过其比例（Kp）、积分（Ki）、和微分（Kd）参数独立响应其控制变量的偏差，这样的设计使得系统可以灵活调整对不同类型误差的响应。这里的关键是，**虽然每个环的输出是独立计算的，但在最终的执行动作上（如驱动电机的PWM信号）是相互影响的**

&#x2F;&#x2F;特点与应用
灵活性高：可以独立调整对角度和速度控制的敏感度和响应特性，使其适应不同的运行条件和性能要求。
简化调试：调试时可以分别优化每个控制环，而不必担心其相互作用，简化了调试过程。
然而，这也可能导致一些挑战：

相互影响：在实际应用中，两个控制环的输出可能会相互影响，特别是在系统动态变化较大时，需要仔细调整参数以避免冲突。
总的来说，你的理解是准确的，这种并级PID控制方式通过独立的线性关系（各自的PID环）合并输出，共同决定了最终的控制行为。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>并级这里速度环是用来提高直立环的输出,从而提高这个系统的响应速度, 那我直接增到直立环的kp不行吗</p>
<h2 id="调参"><a href="#调参" class="headerlink" title="调参"></a>调参</h2><h2 id="pid调节过程及方法"><a href="#pid调节过程及方法" class="headerlink" title="pid调节过程及方法"></a>pid调节过程及方法</h2><h3 id="调参步骤："><a href="#调参步骤：" class="headerlink" title="调参步骤："></a>调参步骤：</h3><blockquote>
<p>1.确立机械中值。<br>2.直立环（内环）—Kp极性、Kp大小。Kd极性、Kd大小。<br>3.速度环（外环）——Kp&amp;Ki极性、Kp&amp;Ki大小。<br>4.转向环——系数极性、系数大小。</p>
</blockquote>
<h4 id="机械中值："><a href="#机械中值：" class="headerlink" title="机械中值："></a>机械中值：</h4><p>把平衡小车放在地面上，从前向后以及从后向前绕电机轴旋转平衡小车，两次的向另一边倒下的角度的中值，就是机械中值。</p>
<h4 id="直立环"><a href="#直立环" class="headerlink" title="直立环"></a>直立环</h4><p>Kp极性：</p>
<blockquote>
<p>极性错误：小车往哪边倒，车轮就往反方向开，会使得小车加速倒下。<br>极性正确：小车往哪边倒，车轮就往哪边开，以保证小车有直立的趋势。<br>Kp大小：<br>Kp一直增加，直到出现大幅低频震荡。<br>Kd极性：()调试kd时,kp暂时设为0()<br>极性错误：拿起小车绕电机轴旋转，车轮反向转动，无跟随。<br>极性正确：拿起小车绕电机轴旋转，车轮同向转动，有跟随。</p>
<p><strong>（那么这是为什么呢？？？）</strong></p>
<p>Kd大小：<br>Kd一直增加，直到出现高频震荡。</p>
</blockquote>
<p>直立环调试完毕后，对所有确立的参数乘以0.6作为最终参数。<br>原因：之前得到的参数都是Kp、Kd最大值，根据工程经验平衡小车的理想参数为最大参数乘以0.6求得。<br>结果：乘以0.6后，小车的抖动消失，但同时直立效果也变差。待下面加入速度环就能得到更好的性能。</p>
<h4 id="速度环"><a href="#速度环" class="headerlink" title="速度环"></a>速度环</h4><p>速度环参数调节前注意：</p>
<ul>
<li>在调试<code>速度环参数极性时</code>：需要去掉（注释掉）<code>直立环运算</code></li>
<li>在调试<code>速度环参数大小</code>时：再次引入（取消注释）<code>直立环运算</code></li>
</ul>
<blockquote>
<p> <code>转向环运算</code>始终是去掉（注释）的一个状态。若转向环已提前将参数调试好，则未注释也影响不大。<br>Kp&amp;Ki：</p>
<p>线性关系、Ki&#x3D;(1&#x2F;200)*Kp、仅调Kp即可。</p>
</blockquote>
<ul>
<li><p>Kp&amp;Ki极性：<br>极性错误：手动转动其中一个车轮，另一车轮会以同样速度反向旋转——典型负反馈。<br>极性正确：手动转动其中一个车轮，两个车伦会同向加速，直至电机最大速度——典型正反馈。</p>
</li>
<li><p>Kp&amp;Ki大小：<br>增加Kp&amp;Ki，直至：小车保持平衡的同时，速度接近于零。且回位效果较好。</p>
</li>
</ul>
<h4 id="转向环"><a href="#转向环" class="headerlink" title="转向环"></a>转向环</h4><ul>
<li>Kp极性：<br>极性错误：拿起小车，并将小车绕Z轴旋转，两车轮旋转的趋势与小车旋转趋势一致——典型正反馈。<br>极性正确：拿起小车，并将小车绕Z轴旋转，两车轮旋转的趋势与小车旋转趋势相反——典型负反馈。</li>
<li>Kp大小：<br>加大Kp，直至走直线效果较好，且无剧烈抖动。</li>
</ul>
<h2 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h2><ol>
<li>在电源打开的情况下,试图拔电机线,结果板子烧了,不知道原因,又买了一块,我以为只是底板和核心板烧了,其他的元器件都是好的,结果又烧了(其他元器件也是坏的),损失亿点点,<code>之后所有的拔线插线操作我都关闭电源进行</code></li>
<li><code>蓝牙串口发送的数据与收到的数据不符</code>,收到的数据为asc码+回车的asc码,也就是发送1收到48,13,<br>解决:</li>
</ol>
<blockquote>
<p>代码是if(data&#x3D;&#x3D;0x01),我发送的数据也是0x01,实际上,前面的0x表示的是16进制,我只需要发送1就可以了,(否则就是十六进制发送四个字符)另外代码是if(data&#x3D;&#x3D;1),也没反应,因为字符需要加引号,即’1’<br>比如说75 &#x2F;16&#x3D;4…..11<br>11是b,所以<code>75化成十六进制是4b</code>,<code>写作0x4b</code>或4BH<br>4.目前遇到的问题:<br>oled闪屏<br>原因:I2C刷新频率太低,导致屏幕一闪一闪的,spi通信没有遇到这个问题<br>1，刷屏方式有没有问题，刷完第一屏，不用清屏，接着刷第二屏，可以减少闪烁感</p>
</blockquote>
<ol start="2">
<li><p>iic通信速度调快点，iic 通信跳到1mbps试试</p>
</li>
<li><p>打点方式是不是最快的，屏幕可以iic连续写入方式，一个启始信号后面跟尽可能多的写入数据。一个启示一个数据，这样打点也会慢很多</p>
</li>
<li><p>刷新频率不够，你可以尝试提高刷新屏幕的任务的优先级</p>
</li>
<li><p>清屏太快？刚写完显示然后不加延时就清屏会闪烁的，OLED 屏幕是静态显示的，不重新写入数据是不会更新显示的，闪烁也有可能是在同一位置数据刷新过快，检查一遍程序</p>
</li>
<li><p>有可能你对屏幕进行了写入操作 但是这个操作不是连续完成的  被其他任务中断了</p>
</li>
<li><p>刷新的时间太长了，可能你的刷新操作被中断打断而中断又占用时间比较长</p>
</li>
<li><p>刷新率不够,估计是延时用多了</p>
</li>
<li><p>iic数据传输的速度太慢了可能，如果传输速度没问题可以看看有没有别的任务占用大量的资源。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.icxbk.com/ask/detail/11888.html?page=2">参考文章</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44457994/article/details/122116964?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-5-122116964-blog-123651067.pc_relevant_aa_2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-5-122116964-blog-123651067.pc_relevant_aa_2&utm_relevant_index=10">参考资料</a><br>接下来:找到提高刷新率的方法<br>1.mpu6050用硬件iic oled用软件iic<br>2.先尝试只让mpu6050显示在oled上</p>
</blockquote>
<h3 id="MPU6050-1"><a href="#MPU6050-1" class="headerlink" title="MPU6050"></a>MPU6050</h3></li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">void MPU6050_EXIT_Init(void)
&#123;
  EXTI_InitTypeDef EXTI_InitStructure;
  GPIO_InitTypeDef GPIO_InitStructure;
  NVIC_InitTypeDef NVIC_InitStructure;            	                                 
 &#x2F;&#x2F;1.不加优先级,无法显示数据
 &#x2F;&#x2F;2.为什么设置了kp值,小车没反应-&gt;因为玄学,重建文件夹复制进去就好了,也有可能是主控出问题了
 RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE);  &#x2F;&#x2F;使能定时器PB的时钟
 RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO,ENABLE);   &#x2F;&#x2F;外部中断，需要使能AFIO时钟 
                                      
 &#x2F;&#x2F;3.改oled要改.c初始化设置,.h引脚定义
 &#x2F;&#x2F;4.改mpu要改.c初始化,.h引脚设置,但是因为用到了int中断引脚,所以还要去改int中断引脚的初始化.c,.h机的都要改
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3.bluetooth(usart)出现电脑发送的的数据和单片机收到的数据不符的问题</p>
<blockquote>
<p>1.可能的原因,数据位不是8位<br>2.晶振问题,波特率问题</p>
</blockquote>
<p>4.玄学问题<br>同样的代码,其中一个就是不好使,从另一个工程复制过来的就好使,然后我把文件夹删了重新复制了.c,.h文件,你猜怎么着,誒,好使了,脑仁都要气没了</p>
<p>5.出现问题的检查步骤</p>
<ul>
<li>1.看下代码有没有引脚用错的问题</li>
<li>2.看看硬件有没有接线错误什么的,换个硬件试一下好使不(因为有的硬件他坏了但是没完全坏,他只是这个功能不能用了,也相当于坏了)</li>
<li>3.仔细检查程序,恩,就是不停的试错吧(煎熬的过程)</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>【平衡小车在线编程课程视频（1~3节合集版本）（2月12日更新）】<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1j7411z7uX?p=3&vd_source=f525a47bd6d8cb5b154158289da1d4d4">https://www.bilibili.com/video/BV1j7411z7uX?p=3&amp;vd_source=f525a47bd6d8cb5b154158289da1d4d4</a></p>
<p><a href="">教程</a><br>感谢大佬’天下行走’<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Fanxy__/article/details/123113682?spm=1001.2101.3001.6650.9&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-9-123113682-blog-113866015.pc_relevant_multi_platform_whitelistv2_ad_hc&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-9-123113682-blog-113866015.pc_relevant_multi_platform_whitelistv2_ad_hc&utm_relevant_index=12">参考文章</a>    </p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2022/06/15/19p-nonebot2-plugin/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2024-06-03 10:26:41
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/STM32F103/" title="STM32F103">
                        #STM32F103
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2022/06/27/21p-re-spider/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%90%E6%96%99%E6%B8%85%E5%8D%95"><span class="toc-text">材料清单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E7%A8%8B%E5%BA%8F"><span class="toc-text">编写程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#motor"><span class="toc-text">motor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PWM"><span class="toc-text">PWM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%9E%84%E5%BB%BA"><span class="toc-text">代码构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Encoder"><span class="toc-text">Encoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MPU6050"><span class="toc-text">MPU6050</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E5%AD%A6%E5%B9%B3%E8%A1%A1%E5%B0%8F%E8%BD%A6"><span class="toc-text">重学平衡小车</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PID%E6%8E%A7%E5%88%B6"><span class="toc-text">PID控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%8D%E7%BD%AEPID"><span class="toc-text">位置PID</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%85%AC%E5%BC%8F%E4%B8%BA%E4%BB%80%E4%B9%88kp%E4%B8%8D-%E8%AF%AF%E5%B7%AE"><span class="toc-text">2.公式为什么kp不*误差</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E7%BA%A7PID"><span class="toc-text">串级PID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9F%E5%BA%A6%E7%8E%AF%E3%80%81%E4%B8%B2%E7%BA%A7PID"><span class="toc-text">速度环、串级PID</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-text">问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%9B%B4%E7%AB%8B%E7%8E%AF%E5%8F%8D%E5%BA%94%E8%BE%83%E6%85%A2%EF%BC%9F"><span class="toc-text">为什么直立环反应较慢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9F%E5%BA%A6%E7%8E%AF%E5%A6%82%E4%BD%95%E5%8A%A0%E5%BF%AB%E5%93%8D%E5%BA%94%EF%BC%9F"><span class="toc-text">速度环如何加快响应？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B2%E7%BA%A7PID%E4%B8%8E%E5%B9%B6%E7%BA%A7PID%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">串级PID与并级PID的区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B2%A1%E5%85%B3%E7%B3%BB-%E5%B2%81%E6%9C%88%E8%BF%98%E9%95%BF-%E6%9C%89%E4%BA%9B%E9%97%AE%E9%A2%98%E5%8F%AF%E4%BB%A5%E6%85%A2%E6%85%A2%E6%83%B3"><span class="toc-text">没关系,岁月还长,有些问题可以慢慢想</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E7%BA%A7PID"><span class="toc-text">并级PID</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%8F%82"><span class="toc-text">调参</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pid%E8%B0%83%E8%8A%82%E8%BF%87%E7%A8%8B%E5%8F%8A%E6%96%B9%E6%B3%95"><span class="toc-text">pid调节过程及方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E5%8F%82%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-text">调参步骤：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%BA%E6%A2%B0%E4%B8%AD%E5%80%BC%EF%BC%9A"><span class="toc-text">机械中值：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E7%AB%8B%E7%8E%AF"><span class="toc-text">直立环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9F%E5%BA%A6%E7%8E%AF"><span class="toc-text">速度环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E5%90%91%E7%8E%AF"><span class="toc-text">转向环</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1"><span class="toc-text">问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MPU6050-1"><span class="toc-text">MPU6050</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2025 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + stm32f103%E5%B9%B3%E8%A1%A1%E5%B0%8F%E8%BD%A6 + '&url=' + http%3A%2F%2Fblog.isgeek.top%2F2022%2F06%2F24%2F20h-stm32f103-balance-car%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://blog.isgeek.top/2022/06/24/20h-stm32f103-balance-car/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
